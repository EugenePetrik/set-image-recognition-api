name: Terraform Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - DEV
          - QA
          - PROD
        default: 'DEV'
      terraform-action:
        description: 'Terraform action'
        required: false
        type: choice
        options:
          - plan
          - apply
          - destroy
        default: 'apply'

jobs:
  terraform:
    name: Terraform ${{ inputs.terraform-action }} - ${{ inputs.environment }}
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set Terraform directory based on environment
        run: |
          ENVIRONMENT="${{ inputs.environment }}"

          case "$ENVIRONMENT" in
            DEV)
              TF_DIR="terraform/tf-dev"
              ENV_LOWER="dev"
              ;;
            QA)
              TF_DIR="terraform/tf-qa"
              ENV_LOWER="qa"
              ;;
            PROD)
              TF_DIR="terraform/tf-prod"
              ENV_LOWER="prod"
              ;;
            *)
              echo "âŒ Invalid environment: $ENVIRONMENT"
              echo "Valid options: DEV, QA, PROD"
              exit 1
              ;;
          esac

          # Set environment variables
          echo "TF_DIR=${TF_DIR}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${ENVIRONMENT}" >> $GITHUB_ENV
          echo "ENV_LOWER=${ENV_LOWER}" >> $GITHUB_ENV

          # Display configuration
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”§ Terraform Configuration"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment:       ${ENVIRONMENT}"
          echo "Terraform Dir:     ${TF_DIR}"
          echo "Action:            ${{ inputs.terraform-action }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ${{ env.TF_DIR }}
        continue-on-error: true

      - name: Terraform Init
        run: |
          echo "ğŸ”§ Initializing Terraform for ${{ env.ENVIRONMENT }} environment..."
          terraform init
        working-directory: ${{ env.TF_DIR }}

      - name: Terraform Validate
        run: |
          echo "âœ… Validating Terraform configuration..."
          terraform validate
        working-directory: ${{ env.TF_DIR }}

      - name: Terraform Plan
        id: plan
        run: |
          echo "ğŸ“‹ Planning Terraform changes for ${{ env.ENVIRONMENT }} environment..."
          terraform plan -out=tfplan
        working-directory: ${{ env.TF_DIR }}

      - name: Terraform Apply
        if: inputs.terraform-action == 'apply'
        run: |
          echo "ğŸš€ Applying Terraform changes for ${{ env.ENVIRONMENT }} environment..."
          terraform apply -auto-approve tfplan
        working-directory: ${{ env.TF_DIR }}

      - name: Terraform Destroy
        if: inputs.terraform-action == 'destroy'
        run: |
          echo "ğŸ’¥ Destroying Terraform resources for ${{ env.ENVIRONMENT }} environment..."
          echo "âš ï¸  This action will delete all resources!"
          terraform destroy -auto-approve
        working-directory: ${{ env.TF_DIR }}

      - name: Display Deployment Information
        if: success() && inputs.terraform-action == 'apply'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Terraform Apply Complete - ${{ env.ENVIRONMENT }} Environment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸš€ Deployment Information:"
          echo ""

          terraform output -json deployment_info | jq -r '
            "  Environment:      \(.environment)",
            "  AWS Region:       \(.aws_region)",
            "",
            "ğŸ”— Application URLs:",
            "  Application:      \(.application_url)",
            "  Health Check:     \(.health_check_url)",
            "  API Docs:         \(.api_docs_url)"
          '

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        working-directory: ${{ env.TF_DIR }}
